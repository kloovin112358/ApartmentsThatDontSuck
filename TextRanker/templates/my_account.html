{% extends "main.html" %}
{% load static %}
{% load humanize %}

{% block title %}
  My Account - {{ user.email }}
{% endblock %}

{% block content %}
<!-- aria-live region for screen readers -->
<div id="notification-region" aria-live="assertive" class="sr-only"></div>

<div class="container mx-auto px-4 py-6">
    <h1 class="mb-4 text-4xl font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl lg:text-6xl dark:text-white">My Account</h1>
    <section>
        <p class="text-md font-medium">You are logged in as {{user.email}}.</p>
        <!-- Log Out Button -->
        <div class="mb-6 mt-4">
            <a href="{% url 'Ranker:logout' %}" class="inline-flex items-center px-4 py-2 text-white bg-gray-800 border border-transparent rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                <!-- Arrow SVG -->
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                </svg>
                Log Out
            </a>
        </div>
    </section>
    <hr class="h-px my-4 bg-gray-200 border-0 dark:bg-gray-700">
    
    {% if not user.verified_account %}
    <section class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
        <h2 class="font-semibold">Your email is not verified.</h2>
        <p>Please verify your email to access all features of your account.</p>
        <a href="{% url 'Ranker:email_verification_required' %}" class="text-blue-500 hover:text-blue-700 font-semibold">Verify Email</a>
    </section>
    {% else %}
        <section>
        {% if savedUnits %}
            <h2 class="text-xl font-semibold mb-4">Your Saved Units</h2>
            <div class="flex flex-wrap">
                {% for savedUnit in savedUnits %}
                <div class="bg-white border border-purple-700 rounded-lg dark:bg-gray-800 dark:border-gray-700 p-6 m-2 max-w-sm">
                    <div style="min-height:13rem">
                        <h3 class="text-3xl text-gray-900 dark:text-white mb-2">
                            <span class="font-bold">{{savedUnit.unit.unitType}}</span> in <span class="font-bold">{{savedUnit.unit.neighborhood}}</span>
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">
                            Quality:
                            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full 
                                {% if savedUnit.unit.quality_rating == 1 %}
                                    bg-red-300 text-red-700
                                {% elif savedUnit.unit.quality_rating == 2 %}
                                    bg-red-200 text-red-700
                                {% elif savedUnit.unit.quality_rating == 3 %}
                                    bg-red-100 text-red-700
                                {% elif savedUnit.unit.quality_rating == 4 %}
                                    bg-red-50 text-red-700
                                {% elif savedUnit.unit.quality_rating == 5 %}
                                    bg-gray-100 text-black
                                {% elif savedUnit.unit.quality_rating == 6 %}
                                    bg-green-50 text-green-700
                                {% elif savedUnit.unit.quality_rating == 7 %}
                                    bg-green-100 text-green-700
                                {% elif savedUnit.unit.quality_rating == 8 %}
                                    bg-green-200 text-green-700
                                {% elif savedUnit.unit.quality_rating == 9 %}
                                    bg-green-300 text-green-700
                                {% elif savedUnit.unit.quality_rating == 10 %}
                                    bg-green-400 text-white
                                {% else %}
                                    bg-white text-black
                                {% endif %}
                            ">
                                {{savedUnit.unit.quality_rating}}/10
                            </span>
                        </p>
                
                        <!-- Value Rating Badge -->
                        <p class="text-gray-600 dark:text-gray-400">
                            Value: 
                            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full 
                                {% if savedUnit.unit.value_rating == 1 %}
                                    bg-red-300 text-red-700
                                {% elif savedUnit.unit.value_rating == 2 %}
                                    bg-red-200 text-red-700
                                {% elif savedUnit.unit.value_rating == 3 %}
                                    bg-red-100 text-red-700
                                {% elif savedUnit.unit.value_rating == 4 %}
                                    bg-red-50 text-red-700
                                {% elif savedUnit.unit.value_rating == 5 %}
                                    bg-gray-100 text-black
                                {% elif savedUnit.unit.value_rating == 6 %}
                                    bg-green-50 text-green-700
                                {% elif savedUnit.unit.value_rating == 7 %}
                                    bg-green-100 text-green-700
                                {% elif savedUnit.unit.value_rating == 8 %}
                                    bg-green-200 text-green-700
                                {% elif savedUnit.unit.value_rating == 9 %}
                                    bg-green-300 text-green-700
                                {% elif savedUnit.unit.value_rating == 10 %}
                                    bg-green-400 text-white
                                {% else %}
                                    bg-white text-black
                                {% endif %}
                            ">
                                {{savedUnit.unit.value_rating}}/10
                            </span>
                        </p>
                        <div>
                            <a href="{{savedUnit.unit.listing_link}}" id="listing-link-{{savedUnit.unit.id}}" class="text-blue-600 dark:text-blue-500 hover:underline text-sm">{{savedUnit.unit.listing_link}}</a>
                            <button data-copy-to-clipboard-target="listing-link-{{savedUnit.unit.id}}" class="text-gray-900 dark:text-gray-400 hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-600 dark:hover:bg-gray-700 rounded-lg py-2 px-2.5 inline-flex items-center justify-center bg-white border-gray-200 border">
                                <span id="default-message-{{savedUnit.unit.id}}" class="inline-flex items-center">
                                    <svg class="w-3 h-3" aria-label="Copy to clipboard" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                                        <path d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2Zm-3 14H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-4H5a1 1 0 0 1 0-2h8a1 1 0 1 1 0 2Zm0-5H5a1 1 0 0 1 0-2h2V2h4v2h2a1 1 0 1 1 0 2Z"/>
                                    </svg>
                                </span>
                                <span id="success-message-{{savedUnit.unit.id}}" class="hidden inline-flex items-center" aria-live="polite">
                                    <svg class="w-3 h-3 text-blue-700 dark:text-blue-500" aria-label="Successfully copied to clipboard" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        
                    </div>
                    <div>
                        <p class="text-4xl text-gray-900 dark:text-white">
                            <span class="font-bold">${{ savedUnit.unit.price|floatformat:0|intcomma }}</span> <span class="text-gray-500">/ mo</span>
                        </p>
                    </div>
                    <!-- Notes and Update Button -->
                    <div class="mt-4">
                        <textarea id="note-{{ savedUnit.id }}" rows="2" class="note block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Add notes for your apartment search here.">{% if savedUnit.notes %}{{ savedUnit.notes }}{% endif %}</textarea>
                        <button type="button" class="save-note-btn text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-xs px-4 py-1.5 text-center mt-1 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" data-unit-id="{{ savedUnit.id }}">
                            Save note
                        </button>
                    </div>                    
                    <hr class="h-px mt-8 mb-2 bg-gray-200 border-0 dark:bg-gray-700">
                    <!-- Action Buttons -->
                    <div class="space-y-2">
                        <!-- Red colored link style buttons -->
                        {% if not savedUnit.has_sucks_report %}
                            <button id="sucks-button-{{ savedUnit.unit.id }}" type="button" onclick="performSucksAction({{ savedUnit.unit.id }})" class="text-red-700 hover:text-red-800 underline font-medium rounded-lg text-xs py-1.5 focus:outline-none focus:ring-4 focus:ring-red-300 dark:text-red-600 dark:hover:text-red-700 dark:focus:ring-red-900">
                                Apartment sucks
                            </button>
                        {% else %}
                            <span class="text-gray-500 italic text-xs">
                                Already reported sucks
                            </span>
                        {% endif %}
                        
                        {% if not savedUnit.has_not_available_report %}
                            <button id="na-button-{{ savedUnit.unit.id }}" type="button" onclick="performNAAction({{ savedUnit.unit.id }})" class="text-red-700 hover:text-red-800 underline font-medium rounded-lg text-xs py-1.5 px-2 focus:outline-none focus:ring-4 focus:ring-red-300 dark:text-red-600 dark:hover:text-red-700 dark:focus:ring-red-700">
                                Apartment is not available
                            </button>
                        {% else %}
                            <span class="text-gray-500 italic text-xs">
                                Already reported not available
                            </span>
                        {% endif %}
                        <!-- Full width black button -->
                        <button type="button" onclick="performRemoveAction('{{ savedUnit.unit.id }}')"
                            class="w-full text-white bg-black hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-xs px-5 py-2.5 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-700">
                            Remove from saved
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
           
        {% else %}
        <div class="block max-w-sm p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
            <svg class="w-[40px] h-[40px] text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7.414A2 2 0 0 0 20.414 6L18 3.586A2 2 0 0 0 16.586 3H5Zm10 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7V5h8v2a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
              </svg>
            <h2 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
                Your saved units will appear here once you save some.</h2>
            <p class="font-normal text-gray-700 dark:text-gray-400"><a href="{% url 'Ranker:home' %}" class="text-blue-500 hover:text-blue-700 font-semibold">Search here for apartments that don't suck.</a></p>
        </div>
        {% endif %}
        </section>

    {% endif %}
    <section class="mt-8 py-4">
        <div class="text-red-500 text-sm mb-2">
            <a href="{% url 'Ranker:password_reset' %}" class="hover:underline">Reset password</a>
        </div>
        <!-- <div class="text-red-500 text-sm mb-2">
            <a href="#" class="hover:underline">Change email</a>
        </div> -->
        <div class="text-red-500 text-sm">
            <a href="{% url 'Ranker:delete_account' %}" class="hover:underline">Delete account</a>
        </div>
    </section>
</div>
<script>
const notificationRegion = document.getElementById('notification-region');

document.querySelectorAll('[data-copy-to-clipboard-target]').forEach(button => {
    button.addEventListener('click', (event) => {
        const targetId = button.getAttribute('data-copy-to-clipboard-target');
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
            const textToCopy = targetElement.textContent || targetElement.value;

            navigator.clipboard.writeText(textToCopy).then(() => {
                showSuccess(button);

                // reset to default state after 2 seconds
                setTimeout(() => {
                    resetToDefault(button);
                }, 2000);
            }).catch(err => {
                console.error('Error copying text: ', err);
            });
        }
    });
});

const showSuccess = (button) => {
    const defaultMessage = button.querySelector('[id^="default-message"]');
    const successMessage = button.querySelector('[id^="success-message"]');
    
    if (defaultMessage && successMessage) {
        defaultMessage.classList.add('hidden');
        successMessage.classList.remove('hidden');

        // Accessibility improvements
        successMessage.setAttribute('role', 'alert');
        successMessage.setAttribute('aria-live', 'assertive');
        successMessage.setAttribute('tabindex', '-1'); // Allow focus for screen readers

        // Optionally, set focus to the success message so that screen readers announce it
        successMessage.focus();
    }
};

const resetToDefault = (button) => {
    const defaultMessage = button.querySelector('[id^="default-message"]');
    const successMessage = button.querySelector('[id^="success-message"]');
    
    if (defaultMessage && successMessage) {
        defaultMessage.classList.remove('hidden');
        successMessage.classList.add('hidden');
        // Remove accessibility attributes
        successMessage.removeAttribute('role');
        successMessage.removeAttribute('aria-live');
        successMessage.removeAttribute('tabindex');
    }
};
document.addEventListener('DOMContentLoaded', function () {
    const saveNoteButtons = document.querySelectorAll('.save-note-btn');

    saveNoteButtons.forEach(button => {
        button.addEventListener('click', function () {
            const unitId = this.getAttribute('data-unit-id');
            const noteTextarea = document.getElementById(`note-${unitId}`);
            const noteContent = noteTextarea.value.trim();  // Get the note content
            
            // Allow saving even with empty notes
            if (noteContent === '') {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "The note is empty, do you still want to save?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, save it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        saveNoteToBackend(unitId, noteContent);  // Call the save function
                    }
                });
            } else {
                saveNoteToBackend(unitId, noteContent);
            }
        });
    });

    function saveNoteToBackend(unitId, noteContent) {
        // Example AJAX request to save the note (you can adjust based on your setup)
        fetch(`{% url "Ranker:ajax_save_note" %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ note: noteContent, saved_unit_id:unitId }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Note saved successfully.',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false,
                    didOpen: () => {
                        notificationRegion.setAttribute('aria-live', 'polite');
                        notificationRegion.innerText = 'Note saved successfully.';
                    }
                });
            } else {
                throw new Error('Save failed');
            }
        })
        .catch(error => {
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while saving the note.',
                icon: 'error',
                didOpen: () => {
                    notificationRegion.setAttribute('aria-live', 'assertive');
                    notificationRegion.innerText = 'An error occurred while saving the note.';
                }
            });
        });
    }
});
// Function to handle "Apartment Sucks" button click
function performSucksAction(unitId) {
    Swal.fire({
        title: 'Why does this apartment suck?',
        input: 'textarea',
        inputPlaceholder: 'Describe why this apartment sucks...',
        inputAttributes: {
            'aria-label': 'Describe why this apartment sucks'
        },
        showCancelButton: true,
        confirmButtonText: 'Submit',
        preConfirm: (description) => {
            if (!description) {
                Swal.showValidationMessage('Please enter a description');
            }
            return description;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("{% url 'Ranker:ajax_sucks_unit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'unit_id': unitId, 'description': result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Report Submitted',
                        text: 'Your report has been submitted successfully.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'polite');
                            notificationRegion.innerText = 'Your report has been submitted successfully.';
                        }
                    });

                    // Update the button or text in the template as needed
                    const sucksButton = document.getElementById(`sucks-button-${unitId}`);
                    if (sucksButton) {
                        sucksButton.innerHTML = '<span class="text-gray-500 italic text-xs">Already reported sucks</span>';
                        sucksButton.classList.add('cursor-not-allowed');
                        sucksButton.setAttribute('disabled', true);
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'assertive');
                            notificationRegion.innerText = data.message || 'An error occurred.';
                        }
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'There was an error submitting your report.',
                    didOpen: () => {
                        notificationRegion.setAttribute('aria-live', 'assertive');
                        notificationRegion.innerText = 'There was an error submitting your report.';
                    }
                });
            });
        }
    });
}

// Function to handle "Apartment Not Available" button click
function performNAAction(unitId) {
    Swal.fire({
        title: 'Confirm Availability',
        text: 'Are you sure this apartment is not available? Your report will be linked to your profile.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, report it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("{% url 'Ranker:ajax_not_available_unit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'unit_id': unitId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Reported',
                        text: 'This apartment has been reported as not available.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'polite');
                            notificationRegion.innerText = 'This apartment has been reported as not available.';
                        }
                    });

                    // Update the button or text in the template as needed
                    const naButton = document.getElementById(`na-button-${unitId}`);
                    if (naButton) {
                        naButton.innerHTML = '<span class="text-gray-500 italic text-xs">Already reported not available</span>';
                        naButton.classList.add('cursor-not-allowed');
                        naButton.setAttribute('disabled', true);
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'assertive');
                            notificationRegion.innerText = data.message || 'An error occurred.';
                        }
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'There was an error submitting your report.',
                    didOpen: () => {
                        notificationRegion.setAttribute('aria-live', 'assertive');
                        notificationRegion.innerText = 'There was an error submitting your report.';
                    }
                });
            });
        }
    });
}
function performRemoveAction(unitId) {
    Swal.fire({
        title: 'Are you sure?',
        text: 'Do you really want to remove this unit from your saved list? Any notes you have made will be deleted.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel',
        preConfirm: () => {
            // If confirmed, perform the AJAX request
            return fetch("{% url 'Ranker:ajax_remove_save' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'unit_id': unitId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success notification
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        text: 'This unit has been removed from your saved list.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'polite');
                            notificationRegion.innerText = 'This unit has been removed from your saved list.';
                        }
                    }).then(() => {
                        // Refresh the page after confirmation
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Unit Not Saved',
                        text: data.message || 'This unit was not found in your saved list.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'assertive');
                            notificationRegion.innerText = data.message || 'This unit was not found in your saved list.';
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to Remove',
                    text: 'There was an error removing the unit.',
                    didOpen: () => {
                        notificationRegion.setAttribute('aria-live', 'assertive');
                        notificationRegion.innerText = 'There was an error removing the unit.';
                    }
                });
            });
        }
    });
}

</script>
{% endblock %}
