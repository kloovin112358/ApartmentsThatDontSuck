{% extends "main.html" %}
{% load static %}
{% load custom_template_tags %}
{% load humanize %}

{% block title %}
  Apartments That Don't Suck (ATDS)
{% endblock %}

{% block content %}

<!-- heading for screen readers -->
<h1 class="sr-only">Apartments That Don't Suck - Apartments List</h1>
<!-- aria-live region for screen readers -->
<div id="notification-region" aria-live="assertive" class="sr-only"></div>


<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
/>
<style>
.choices__list--multiple .choices__item {
    background-color: rgb(28 100 242);
    border: 1px solid rgb(28, 60, 242);
}
.choices__list--multiple .choices__item.is-highlighted {
    background-color: rgb(28, 28, 242);
    border: 1px solid rgb(67, 28, 242);
}

@media (max-width: 768px) {
    #filtersDiv {
        max-width: 20rem; /* 320px */
    }
}
</style>
<section class="max-w-screen-3xl mx-auto" id="pageContentContainer">
    <div id="filtersContainer flex items-center justify-center" class="bg-white shadow-lg">
        <div class="hidden md:flex items-center justify-center mx-auto" id="filtersDiv">
            <form class="p-2 md:flex md:items-center md:space-x-10 flex-wrap justify-center" id="filterForm">
                <!-- Unit Type Section -->
                <div class="py-4">
                    <h3 class="text-lg font-semibold mb-2">Unit Type</h3>
                    <div class="flex space-x-4">
                        <div class="flex items-center space-x-2">
                            <input id="studioCheckbox" name="studioCheckbox" data-unit-type="Studio" type="checkbox" class="unitTypeCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                            <label for="studioCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">Studio</label>
                        </div>
                    
                        <div class="flex items-center space-x-2">
                            <input id="1bedcheckbox" name="1bedcheckbox" data-unit-type="1-Bedroom" type="checkbox" class="unitTypeCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                            <label for="1bedcheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">1-Bed</label>
                        </div>
                    
                        <div class="flex items-center space-x-2">
                            <input id="2bedCheckbox" name="2bedCheckbox" data-unit-type="2-Bedroom" type="checkbox" class="unitTypeCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                            <label for="2bedCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">2-Bed</label>
                        </div>
                    
                        <div class="flex items-center space-x-2">
                            <input id="3bedCheckbox" name="3bedCheckbox" data-unit-type="3-Bedroom" type="checkbox" class="unitTypeCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                            <label for="3bedCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">3-Bed</label>
                        </div>
                    </div>
                    
                </div>
    
                <!-- Price Section -->
                <div class="py-4">
                    <h3 class="text-lg font-semibold mb-2">Price (per Month)</h3>
                    <div class="flex space-x-2">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">$</span>
                            <input aria-label="Minimum Price" id="minPriceInput" type="number" placeholder="Min Price" class="pl-8 pr-4 py-2 border border-gray-300 rounded-lg text-s" style="max-width:8.5rem;" min="0" max="99999">
                        </div>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">$</span>
                            <input aria-label="Maximum Price" id="maxPriceInput" type="number" placeholder="Max Price" class="pl-8 pr-4 py-2 border border-gray-300 rounded-lg text-s" style="max-width:8.5rem;" min="0" max="99999">
                        </div>
                    </div>
                </div>
    
                <!-- Neighborhood/Region Section -->
                <div class="py-4">
                    <div class="flex items-center space-x-4 mb-2">
                        <!-- Neighborhood Radio Button -->
                        <div class="inline-flex items-center">
                            <input type="radio" id="locationTypeRadioNeighborhood" name="locationType" value="neighborhood" class="w-4 h-4 border-gray-300 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-600 dark:focus:bg-blue-600 dark:bg-gray-700 dark:border-gray-600" checked="checked" />
                            <label for="locationTypeRadioNeighborhood" class="ms-2 text-gray-900 dark:text-gray-300 text-lg font-semibold">Neighborhood</label>
                        </div>
                    
                        <!-- Region Radio Button -->
                        <div class="inline-flex items-center">
                            <input type="radio" id="locationTypeRadioRegion" name="locationType" value="region" class="w-4 h-4 border-gray-300 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-600 dark:focus:bg-blue-600 dark:bg-gray-700 dark:border-gray-600" />
                            <label for="locationTypeRadioRegion" class="ms-2 text-gray-900 dark:text-gray-300 text-lg font-semibold">City Region</label>
                        </div>
                    </div>
                    
                    
                    <div class="dropdown">
                        <select id="neighborhood-select" class="neighborhood-select border border-gray-300 rounded-lg p-2" aria-label="Neighborhoods filter" multiple>
                            {% for neighborhood in neighborhoods %}
                            <option value="{{neighborhood.id}}">{{neighborhood.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Region Checkboxes with Flowbite styles -->
                    <div class="region-checkboxes flex align-items-center hidden" style="min-height:49.85px;">
                        <div class="flex gap-3">
                            <div class="flex items-center space-x-2">
                                <input id="loopCheckbox" name="loopCheckbox" data-region="Loop" type="checkbox" class="regionCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                                <label for="loopCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">Loop</label>
                            </div>
                    
                            <div class="flex items-center space-x-2">
                                <input id="northCheckbox" name="northCheckbox" data-region="North" type="checkbox" class="regionCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                                <label for="northCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">North</label>
                            </div>
                    
                            <div class="flex items-center space-x-2">
                                <input id="westCheckbox" name="westCheckbox" data-region="West" type="checkbox" class="regionCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                                <label for="westCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">West</label>
                            </div>
                    
                            <div class="flex items-center space-x-2">
                                <input id="southCheckbox" name="southCheckbox" data-region="South" type="checkbox" class="regionCheckbox form-checkbox text-blue-600 rounded focus:ring focus:ring-blue-300 dark:focus:ring-blue-800">
                                <label for="southCheckbox" class="text-sm font-medium text-gray-900 dark:text-gray-300">South</label>
                            </div>
                        </div>
                    </div>
                    
                </div>
    
                <!-- Submit and Save Search Buttons -->
                <div class="pt-4 md:pb-4" id="buttonsActionDiv">
                    <button id="filterBtn" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Filter</button>
                    <button id="clearFiltersBtn" type="button" class="text-blue-700 hover:text-white border border-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center mb-2 dark:border-blue-500 dark:text-blue-500 dark:hover:text-white dark:hover:bg-blue-500 dark:focus:ring-blue-800">Clear Filters</button>
                    {% if showLoggedInRequiredItems %}<button id="saveSearchBtn" type="button" class="ml-3 font-medium text-blue-600 dark:text-blue-500 hover:underline">Save Search</button>{% endif %}
                </div>
            </form>
        </div>
        {% if showLoggedInRequiredItems and savedSearches %}
        <div class="pt-4 md:pb-4">
            {% if savedSearches %}
                <ul class="flex flex-wrap justify-center space-x-4">
                    {% for savedSearch in savedSearches %}
                        <li class="flex items-center">
                            <a href="{{ savedSearch.search }}" class="savedSearchURL mx-1 text-blue-600 hover:underline">{{ savedSearch.search_name }}</a>
                            <button class="editSavedSearchBtn" data-for="{{savedSearch.id}}" aria-label="Edit saved search {{ savedSearch.search_name }}">
                                <svg aria-hidden="true" class="w-6 h-6 text-gray-600 hover:text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                </svg>
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {% endif %}
        <div class="flex items-center justify-center p-2">
            <button data-collapse-toggle="filtersDiv" type="button" class="p-2 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="filtersDiv" aria-expanded="false">
                Toggle Filters
            </button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const neighborhoodRadio = document.querySelector('input[name="locationType"][value="neighborhood"]');
            const regionRadio = document.querySelector('input[name="locationType"][value="region"]');
            const dropdownMenu = document.querySelector('.dropdown');
            const regionCheckboxes = document.querySelector('.region-checkboxes');
            let numEntriesPerPage = 10;
        
            // Initialize with Neighborhood dropdown visible
            dropdownMenu.classList.remove('hidden');
            regionCheckboxes.classList.add('hidden');

            function checkNeighborhoodRadio() {
                if (neighborhoodRadio.checked) {
                    dropdownMenu.classList.remove('hidden');
                    regionCheckboxes.classList.add('hidden');
                }
            }

            function checkRegionRadio() {
                if (regionRadio.checked) {
                    dropdownMenu.classList.add('hidden');
                    regionCheckboxes.classList.remove('hidden');
                }
            }

            // Event listener for Neighborhood radio
            neighborhoodRadio.addEventListener('change', function () {
                checkNeighborhoodRadio()
            });
        
            // Event listener for Region radio
            regionRadio.addEventListener('change', function () {
                checkRegionRadio()
            });
            const filterBtn = document.getElementById('filterBtn');
            const neighborhoodSelect = new Choices('#neighborhood-select', {
                removeItemButton: true,
                searchEnabled: false,
                placeholderValue: 'Select neighborhoods'
            });
            let params = new URLSearchParams();

            function setQueryParamsFromURL() {
                params = new URLSearchParams(window.location.search);
            }

            const notificationRegion = document.getElementById('notification-region');
            const spinner = document.getElementById("spinner")
            const resultTable = document.getElementById("resultContent")
            const unitActionContainer = document.getElementById("unitActionContainer")

            function hideTableAndExtras() {
                resultTable.classList.add('hidden')
                resultTable.setAttribute('aria-hidden', 'true');
                resultTable.innerHTML = ""
                if (unitActionContainer) {
                    unitActionContainer.classList.add('hidden')
                    unitActionContainer.setAttribute('aria-hidden', 'true');
                }
                
                spinner.classList.remove('hidden')
                spinner.removeAttribute('aria-hidden')
            }

            function unhideTableAndExtras() {
                spinner.classList.add('hidden')
                spinner.setAttribute('aria-hidden', 'true');
                resultTable.classList.remove('hidden')
                resultTable.removeAttribute('aria-hidden')
                if (!(document.getElementById("404Result")) && unitActionContainer) {
                    unitActionContainer.classList.remove('hidden')
                    unitActionContainer.removeAttribute('aria-hidden')
                }
            }

            function loadNewContent(data) {
                document.getElementById("resultContent").innerHTML = data.html
                if (document.getElementById("filter-table") && typeof simpleDatatables.DataTable !== 'undefined') {
                    const dataTable = new simpleDatatables.DataTable("#filter-table", {
                        tableRender: (_data, table, type) => {
                            if (type === "print") {
                                return table;
                            }
            
                            return table;
                        },
                        perPage:numEntriesPerPage,
                    });
                    // Hide the spinner once the DataTable is initialized
                    dataTable.on("datatable.init", () => {
                        
                        // Select all radio buttons with a specific class or name
                        const radioButtons = document.querySelectorAll('input[type="radio"][name="select-radio"]');
                        radioButtons.forEach((radio) => {
                        radio.addEventListener('change', (event) => {
                            if (radio.checked) {
                                selectedRadioId = radio.id
                            }
                        });
                        });
                    });
                    dataTable.on('datatable.pager', storeSelectedRadio);
                    dataTable.on('datatable.sort', storeSelectedRadio);
                    dataTable.on('datatable.search', storeSelectedRadio);
                    dataTable.on('datatable.update', () => {
                        const checkedRadio = document.querySelector('input[type="radio"][name="select-radio"]:checked');
                        if (checkedRadio) {
                            checkedRadio.checked = false;
                        }
                        if (selectedRadioId) {
                            const radioToSelect = document.getElementById(selectedRadioId);
                            if (radioToSelect) {
                                radioToSelect.checked = true;
                            }
                        }
                        numEntriesPerPage = dataTable.options.perPage;
                    });
                }
                unhideTableAndExtras()
            }

            function isNumericAndBelow99999(str) {
                // Check if the string is numeric using a regular expression
                if (/^\d+$/.test(str)) {
                    // Convert the string to a number and check if it's below 99999
                    const num = Number(str);
                    return num < 99999;
                }
                return false;
            }

            function cityRegionParamChecks(locations) {
                // Get all checkboxes with the class 'regionCheckbox'
                const regionCheckboxes = document.querySelectorAll('.regionCheckbox');
                let returnValue = true;
                // Loop through locations array
                locations.forEach(location => {
                    // Loop through each checkbox
                    let foundMatch = false;
                    regionCheckboxes.forEach(checkbox => {
                        if (checkbox.getAttribute('data-region') === location) {
                            checkbox.checked = true; // Check the checkbox if there's a match
                            foundMatch = true;
                        }
                    });
                    if (!foundMatch) {
                        returnValue = false;
                        return false
                    }
                });
                return returnValue;
            }

            function unitTypesParamChecks(unitTypes) {
                if (unitTypes) {
                    unitTypes = JSON.parse(unitTypes)
                    const unitTypeCheckboxesAll = document.querySelectorAll(".unitTypeCheckbox")
                    unitTypes.forEach(unitType => {
                        let foundMatch = false;
                        // Loop through each checkbox
                        unitTypeCheckboxesAll.forEach(checkbox => {
                            if (checkbox.getAttribute('data-unit-type') === unitType) {
                                checkbox.checked = true; // Check the checkbox if there's a match
                                foundMatch = true;
                            }
                        });
                        if (!foundMatch) {
                            return false
                        }
                    });
                }
                return true;
            }

            function isSublist(mainList, sublist) {
                return sublist.every(item => mainList.includes(item));
            }            

            function setChoiceSafely(locations) {
                // Get all available choices
                const decodedLocations = decodeURIComponent(locations).split(","); // Decode the URL-encoded string
                const allChoices = neighborhoodSelect._presetChoices.map(choice => choice.value);
                if (!(decodedLocations.length > allChoices.length)) {
                    // Check if the value exists in the available choices
                    if (isSublist(allChoices, decodedLocations)) {
                        neighborhoodSelect.setChoiceByValue(locations);  // Set the choice if it exists
                    } else {
                        throw new Error(`Neighborhood(s) provided did not match those in the search dropdown options.`);
                    }
                } else {
                    throw new Error(`Too many neighborhoods provided.`);
                }
                
            }
            
            // Function to get filters and send AJAX request
            const filterUnits = (initialPageLoad) => {
                hideTableAndExtras()
                
                if (!initialPageLoad) {
                    params = new URLSearchParams();
                    // Get Unit Type Filters
                    const unitTypeCheckboxes = document.querySelectorAll('.unitTypeCheckbox:checked');
                    const unitTypeFilters = Array.from(unitTypeCheckboxes).map(checkbox => checkbox.dataset.unitType);
            
                    // Get Min and Max Prices
                    const minPrice = document.getElementById('minPriceInput').value;
                    const maxPrice = document.getElementById('maxPriceInput').value;
            
                    // Determine Selected Location Type and Get Relevant Filters
                    const locationType = document.querySelector('input[name="locationType"]:checked').value;
                    let locationFilters = [];
                    if (locationType === 'neighborhood') {
                        locationFilters = neighborhoodSelect.getValue(true)
                    } else if (locationType === 'region') {
                        const regionCheckboxes = document.querySelectorAll('.regionCheckbox:checked');
                        locationFilters = Array.from(regionCheckboxes).map(checkbox => checkbox.dataset.region);
                    }
            
                    // Prepare data for AJAX
                    if (unitTypeFilters && unitTypeFilters.length) {
                        params.append('unit_types', JSON.stringify(unitTypeFilters));
                    } else {
                        params.delete('unit_types')
                    }

                    if (minPrice) {
                        if (isNumericAndBelow99999(minPrice)) {
                            params.append('min_price', minPrice);
                        } else {
                            console.error('Error: invalid min price value.');
                            params.delete('min_price')
                        }
                    } else {
                        params.delete('min_price')
                    }

                    if (maxPrice) {
                        if (isNumericAndBelow99999(maxPrice)) {
                            params.append('max_price', maxPrice);
                        } else {
                            console.error('Error: invalid max price value.');
                            params.delete('max_price')
                        }
                    } else {
                        params.delete('max_price')
                    }

                    if (locationType && locationFilters && locationFilters.length) {
                        params.append('location_filter_type', locationType);
                        params.append('locations', JSON.stringify(locationFilters));
                    } else {
                        params.delete('location_filter_type')
                        params.delete('locations')
                    }

                } else {
                    setQueryParamsFromURL()
                    const locationFilterType = params.get('location_filter_type')
                    const minPrice = params.get('min_price')
                    const maxPrice = params.get('max_price')
                    let unitTypes = params.get('unit_types')
                    let locations = params.get('locations')

                    if (minPrice) {
                        if (isNumericAndBelow99999(minPrice)) {
                            document.getElementById('minPriceInput').value = minPrice; 
                        } else {
                            console.error('Error: invalid min price value.');
                            document.getElementById('minPriceInput').value = ""
                            params.delete('min_price')
                        }  
                    }

                    if (maxPrice) {
                        if (isNumericAndBelow99999(maxPrice)) {
                            document.getElementById('maxPriceInput').value = maxPrice; 
                        } else {
                            console.error('Error: invalid max price value.');
                            document.getElementById('maxPriceInput').value = ""
                            params.delete('max_price')
                        }  
                    }
                    
                    if (!unitTypesParamChecks(unitTypes)) {
                        console.error("Invalid unit type(s).")
                        params.delete('unit_types')
                        //uncheck all boxes
                        document.querySelectorAll(".unitTypeCheckbox").forEach(checkbox => {
                            checkbox.checked = false; // Check the checkbox if there's a match
                        });
                    }

                    if (locationFilterType) {
                        if (locationFilterType == "neighborhood") {
                            document.getElementById("locationTypeRadioNeighborhood").checked = true
                            if (locations) {
                                locations = JSON.parse(locations)
                                try {
                                    setChoiceSafely(locations);  // Replace "SomeLocation" with the actual location value
                                } catch (error) {
                                    console.error(error.message);  // Handle the error as needed
                                    params.delete('location_filter_type')
                                    params.delete('locations')
                                }
                            } 
                            checkNeighborhoodRadio()                           
                        } else if (locationFilterType == "region") {
                            document.getElementById("locationTypeRadioRegion").checked = true
                            if (locations) {
                                locations = JSON.parse(locations)
                                if (!cityRegionParamChecks(locations)) {
                                    console.error("Invalid city region(s).")
                                    params.delete('location_filter_type')
                                    params.delete('locations')
                                    document.querySelectorAll(".regionCheckbox").forEach(checkbox => {
                                        checkbox.checked = false;
                                    });

                                }
                            }
                            checkRegionRadio()  
                        } else {
                            console.error("Invalid location type.")
                            params.delete('location_filter_type')
                            params.delete('locations')
                        }
                    }
                }
                // Send AJAX Request
                fetch(`{% url "Ranker:ajax_get_units" %}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    loadNewContent(data)
                    // Handle response data (update your UI accordingly)
                    const stringParams = params.toString()
                    let newUrl = `{% url "Ranker:home" %}`
                    if (stringParams.length !== 0) {
                        newUrl = newUrl + `?${stringParams}`;
                    }
                    window.history.pushState({ path: newUrl }, '', newUrl);
                })
                .catch(error => {
                    window.location.href = `{% url "Ranker:home" %}`
                });
            };
        
            // Event Listener for Filter Button
            filterBtn.addEventListener('click', function() {
                filterUnits(false);
            });

            document.getElementById("clearFiltersBtn").addEventListener('click', function() {
                window.location.href = "{% url 'Ranker:home' %}"
            });
            //{% if showLoggedInRequiredItems %}
            function launchSaveSearchModal() {
                Swal.fire({
                    title: 'Save Search',
                    text: 'The active search will be saved to your account.',
                    input: 'text',
                    inputLabel: "Please provide a name for this search.",
                    inputPlaceholder: 'Ex: Logan Square 2-Beds',
                    inputAttributes: {
                        'aria-label': 'Provide a name for this search.',
                        'maxlength': '40'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Save Search',
                    preConfirm: (search_name) => {
                        if (!search_name) {
                            Swal.showValidationMessage('Please enter a search name.');
                        }
                        return search_name;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch("{% url 'Ranker:ajax_save_search' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 'search_name': result.value, 'search': window.location.href })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload()
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'An error occurred.',
                                    didOpen: () => {
                                        notificationRegion.setAttribute('aria-live', 'assertive');
                                        notificationRegion.innerText = data.message || 'An error occurred.';
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'There was an error submitting your request.',
                                didOpen: () => {
                                    notificationRegion.setAttribute('aria-live', 'assertive');
                                    notificationRegion.innerText = 'There was an error submitting your request.';
                                }
                            });
                        });
                    }
                });
            }
            document.getElementById("saveSearchBtn").addEventListener('click', function() {
                filterUnits(false);
                launchSaveSearchModal();
            });
            //{% endif %}
            
            // Run filter on page load
            filterUnits(true);
            //{% if showLoggedInRequiredItems and savedSearches %}
            // Select all buttons with the class editSavedSearchBtn
            const editButtons = document.querySelectorAll('.editSavedSearchBtn');
            const editSavedSearchModal = document.getElementById('editSavedSearchModal');

            // Add event listener for each button
            editButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove the hidden class from the editSavedSearchModal
                    
                    editSavedSearchModal.classList.remove('hidden');

                    // Get the savedSearchURL sibling element
                    const savedSearchURL = button.previousElementSibling;

                    // Set values for savedSearchLink and savedSearchName
                    const savedSearchLink = document.getElementById('savedSearchLink');
                    const savedSearchName = document.getElementById('savedSearchName');
                    const savedSearchId = document.getElementById('savedSearchId');

                    savedSearchLink.value = savedSearchURL.getAttribute('href'); // Get href
                    savedSearchName.value = savedSearchURL.innerHTML; // Get innerHTML
                    savedSearchId.value = button.getAttribute('data-for')
                });
            });

            const cancelSavedSearchButton = document.getElementById('cancelButtonSavedSearch');
            const deleteSavedSearchButton = document.getElementById('deleteSavedSearchButton');
            const editSavedSearchForm = document.getElementById('editSavedSearchForm');

            cancelSavedSearchButton.addEventListener('click', function() {
                editSavedSearchModal.classList.add('hidden');
            });

            

            deleteSavedSearchButton.addEventListener('click', function() {
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you really want to delete this saved search?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it!',
                    cancelButtonText: 'Cancel',
                    preConfirm: () => {
                        // If confirmed, perform the AJAX request
                        return fetch("{% url 'Ranker:ajax_delete_saved_search' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 'unit_id': document.getElementById('savedSearchId').value })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                location.reload();
                                // Show success notification
                                
                            } else {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Unit Not Saved',
                                    text: data.message || 'This unit was not found in your saved list.',
                                    didOpen: () => {
                                        notificationRegion.setAttribute('aria-live', 'assertive');
                                        notificationRegion.innerText = data.message || 'This unit was not found in your saved list.';
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed to Remove',
                                text: 'There was an error removing the saved search.',
                                didOpen: () => {
                                    notificationRegion.setAttribute('aria-live', 'assertive');
                                    notificationRegion.innerText = 'There was an error removing the saved search.';
                                }
                            });
                        });
                    }
                });
            })

            editSavedSearchForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const savedSearchId = document.getElementById('savedSearchId').value;
                const formData = new FormData(editSavedSearchForm);

                fetch(`{% url "Ranker:ajax_update_saved_search" %}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the table or the UI accordingly
                        location.reload(); // Reload the page to see the changes
                    } else {
                        // Handle errors
                        alert('An error occurred while saving your changes. Please try again.');
                    }
                });
            });
            //{% endif %}


        });
        
        
    </script>
    
    
    <div class="px-2 pt-4 pb-24">
        {% if showLoggedInRequiredItems %}
        <div class="max-w-md flex items-center space-x-2 mb-3" id="unitActionContainer">
            <label for="rowAction" class="block text-sm font-medium text-gray-900 dark:text-white">
                Unit action
            </label>
            <select id="rowAction" name="rowAction" aria-label="Select an action for the unit" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 p-1.5">
                <option value="">----------</option>
                <option value="Save">Save/Unsave Unit</option>
                <option value="Sucks">Report that Apartment Sucks</option>
                <option value="NA">Report Apartment as Not Available</option>
                {% if request.user.is_staff == True %}
                <option value="Edit">Edit</option>
                <option value="Delete">Delete</option>
                {% endif %}
            </select>
            <button type="button" id="submitActionBtn" aria-label="Submit action for unit" class="px-3 py-2 text-xs font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Go
            </button>
        </div>
        
    {% else %}
        <!-- <div class="mb-4">
            <p>
                <a href="{% url 'Ranker:sign_up' %}" class="font-medium text-blue-600 dark:text-blue-500 hover:underline" aria-label="Sign up for an account">Sign up</a> or <a href="{% url 'Ranker:login_page' %}" class="font-medium text-blue-600 dark:text-blue-500 hover:underline" aria-label="Log in to your account">log in</a> to save and report listings.
            </p>
        </div> -->
        
    {% endif %}
        <div role="status" id="spinner" class="container mx-auto mt-4">
            <div class="flex justify-center align-center">
                <svg aria-hidden="true" class="w-16 h-16 text-gray-200 animate-spin dark:text-gray-600 fill-purple-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <section id="resultContent" class="hidden"></section>
        
    </div>
</section>
{% if request.user.is_staff %}
<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6" role="document">
        <h2 id="editModalLabel" class="text-xl font-semibold mb-4">Edit Unit</h2>
        <form id="editForm" aria-labelledby="editModalLabel">
            <input type="hidden" id="unitId" name="unitId">

            <!-- Status -->
            <div class="mb-4">
                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                <select id="status" name="status" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
                    {% for status in unit_statuses %}
                    <option value="{{status.value}}">{{status.label}}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Neighborhood -->
            <div class="mb-4">
                <label for="neighborhood" class="block text-sm font-medium text-gray-700">Neighborhood</label>
                <select id="neighborhood" name="neighborhood" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
                    {% for neighborhood in neighborhoods %}
                    <option value="{{neighborhood.id}}">{{neighborhood.name}}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Category -->
            <div class="mb-4">
                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                <select id="category" name="category" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
                    {% for category in categories %}
                    <option value="{{category.1}}">{{category.1}}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Unit Type -->
            <div class="mb-4">
                <label for="unitType" class="block text-sm font-medium text-gray-700">Unit Type</label>
                <select id="unitType" name="unitType" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
                    {% for unit_type in unit_types %}
                    <option value="{{unit_type.id}}">{{unit_type.unitType}}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Listing Link -->
            <div class="mb-4">
                <label for="listingLink" class="block text-sm font-medium text-gray-700">Listing Link</label>
                <input type="url" id="listingLink" name="listing_link" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
            </div>

            <!-- Price -->
            <div class="mb-4">
                <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
                <input type="number" id="price" name="price" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
            </div>

            <!-- Quality Rating -->
            <div class="mb-4">
                <label for="qualityRating" class="block text-sm font-medium text-gray-700">Quality Rating</label>
                <input type="number" id="qualityRating" name="quality_rating" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
            </div>

            <div class="mb-4">
                <label for="note" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Note</label>
                <textarea id="note" name="note" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Any notes will appear here"></textarea>
            </div>

            <!-- Save Button -->
            <div class="flex justify-end">
                <button type="button" id="cancelButton" class="bg-gray-500 text-white px-4 py-2 rounded-md mr-2">Cancel</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if showLoggedInRequiredItems and savedSearches %}
<div id="editSavedSearchModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6" role="document">
        <h2 id="editSavedSearchModalLabel" class="text-xl font-semibold mb-4">Edit Saved Search</h2>
        <form id="editSavedSearchForm" aria-labelledby="editSavedSearchModalLabel" action="/">
            <input type="hidden" id="savedSearchId" name="savedSearchId">

            <!-- Listing Link -->
            <div class="mb-4 mt-6">
                <label for="savedSearchLink" class="block text-sm font-medium text-gray-700">Saved Search URL</label>
                <input type="url" id="savedSearchLink" name="search" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md">
            </div>

            <div class="mb-4">
                <label for="savedSearchName" class="block text-sm font-medium text-gray-700">Saved Search Name</label>
                <input type="text" id="savedSearchName" name="search_name" class="mt-1 bg-gray-50 block w-full p-2 border border-gray-300 rounded-md" maxlength="40">
            </div>

            <!-- Save Button -->
            <div class="flex justify-between mt-8 flex-wrap">
                <button type="button" id="cancelButtonSavedSearch" class="bg-gray-500 text-white px-4 py-2 rounded-md">Cancel</button>
                <div>
                    <button type="button" id="deleteSavedSearchButton"  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">Delete</button>
                    <button type="submit" id="saveChangesSavedSearchBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Save Changes</button>
                  </div>                  
            </div>
        </form>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
<script>
let selectedRadioId = null;


// Function to store selected radio ID
function storeSelectedRadio() {
    const selectedRadio = document.querySelector('input[name="select-radio"]:checked');
    if (selectedRadio) {
        selectedRadioId = selectedRadio.id;
    }
}


</script>

{% if showLoggedInRequiredItems %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var unitId = null
    var radioCheckedButton = null
    var badgeTD = null
    const notificationRegion = document.getElementById('notification-region');
    // Attach event listener to the button
    document.getElementById('submitActionBtn').addEventListener('click', function () {
        // Get the select element and its value
        const selectElement = document.getElementById('rowAction');
        const selectedValue = selectElement.value;

        // Get all radio buttons
        const radioButtons = document.querySelectorAll('input[name="select-radio"]');
        radioCheckedButton = Array.from(radioButtons).find(radio => radio.checked);

        // Check if select value is empty or no radio button is checked
        if (selectedValue === "") {
            Swal.fire({
                icon: 'error',
                title: 'Error performing action',
                text: 'Please select a value from the "action" dropdown.',
            });
            return;
        }

        if (!radioCheckedButton) {
            Swal.fire({
                icon: 'error',
                title: 'Error performing action',
                text: 'Please select at least one unit for your action (use the radio buttons in the left-hand column).',
            });
            return;
        }

        unitId = radioCheckedButton.getAttribute('data-unit-id')
        badgeTD = radioCheckedButton.closest('tr').querySelector('td.badgeTD')

        // Perform actions based on the value of the select element
        switch (selectedValue) {
            case 'Save':
                performSaveUnsaveAction();
                break;
            case 'Sucks':
                performSucksAction();
                break;
            case 'NA':
                performNAAction();
                break;
            case 'Edit':
                performEditAction();
                break;
            case 'Delete':
                performDeleteAction();
                break;
            default:
                Swal.fire({
                    icon: 'error',
                    title: 'Error performing action',
                    text: 'An unexpected error occurred.',
                });
                break;
        }
    });

    // Define the action functions
    function performSaveUnsaveAction() {
        // check if already saved
        if (radioCheckedButton.getAttribute('data-is-saved') === 'false') {
            // Event listener for saving units
            fetch("{% url 'Ranker:ajax_save_unit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'unit_id': unitId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const newBadgeDiv = document.createElement('div');
                    newBadgeDiv.innerHTML = '<span class="bg-green-100 text-green-800 text-xs font-medium me-2 mb-2 px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Saved</span>';
                    // Find the <td> with class 'badgeTD'
                    if (badgeTD) {
                        badgeTD.appendChild(newBadgeDiv); // Add the new <div> to the <td>
                    }
                    radioCheckedButton.setAttribute('data-is-saved', 'true');

                    // Show success notification
                    Swal.fire({
                        icon: 'success',
                        title: 'Saved!',
                        text: 'This unit has been saved to your profile.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'polite');
                            notificationRegion.innerText = 'This unit has been saved to your profile.';
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Already Saved',
                        text: 'This unit was already saved to your profile.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'assertive');
                            notificationRegion.innerText = 'This unit was already saved to your profile.';
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to Save',
                    text: 'There was an error saving the unit.',
                    didOpen: () => {
                        notificationRegion.setAttribute('aria-live', 'assertive');
                        notificationRegion.innerText = 'There was an error saving the unit.';
                    }
                });
            });
        } else {
            // if already saved-> action=remove
            Swal.fire({
                title: 'Are you sure?',
                text: 'Do you really want to remove this unit from your saved list? Any notes you have made will be deleted.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove it!',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    // If confirmed, perform the AJAX request
                    return fetch("{% url 'Ranker:ajax_remove_save' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 'unit_id': unitId })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {

                            const badgeDivToRemove = badgeTD.querySelector('div > span.bg-green-100');
                            if (badgeDivToRemove) {
                                badgeDivToRemove.parentElement.remove(); // Remove the parent <div>
                            }
                            radioCheckedButton.setAttribute('data-is-saved', 'false');

                            // Show success notification
                            Swal.fire({
                                icon: 'success',
                                title: 'Removed!',
                                text: 'This unit has been removed from your saved list.',
                                didOpen: () => {
                                    notificationRegion.setAttribute('aria-live', 'polite');
                                    notificationRegion.innerText = 'This unit has been removed from your saved list.';
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'info',
                                title: 'Unit Not Saved',
                                text: data.message || 'This unit was not found in your saved list.',
                                didOpen: () => {
                                    notificationRegion.setAttribute('aria-live', 'assertive');
                                    notificationRegion.innerText = data.message || 'This unit was not found in your saved list.';
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed to Remove',
                            text: 'There was an error removing the unit.',
                            didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'assertive');
                                notificationRegion.innerText = 'There was an error removing the unit.';
                            }
                        });
                    });
                }
            });
        }
    }

    function performSucksAction() {
        // Open the modal
        Swal.fire({
            title: 'Why does this apartment suck?',
            input: 'textarea',
            inputPlaceholder: 'Describe why this apartment sucks...',
            inputAttributes: {
                'aria-label': 'Describe why this apartment sucks'
            },
            showCancelButton: true,
            confirmButtonText: 'Submit',
            preConfirm: (description) => {
                if (!description) {
                    Swal.showValidationMessage('Please enter a description');
                }
                return description;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{% url 'Ranker:ajax_sucks_unit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'unit_id': unitId, 'description': result.value })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Report Submitted',
                            text: 'Your report has been submitted successfully.',
                            didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'polite');
                                notificationRegion.innerText = 'Your report has been submitted successfully.';
                            }
                        });

                        const sucksBadgeDiv = document.createElement('div');
                        sucksBadgeDiv.innerHTML = '<span class="bg-red-100 text-red-800 text-xs font-medium me-2 mb-2 px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-300">Reported (Sucks)</span>';

                        // Find the <td> with class 'badgeTD'
                        if (badgeTD) {
                            badgeTD.appendChild(sucksBadgeDiv); // Add the new <div> to the <td>
                        }
                        radioCheckedButton.setAttribute('data-is-reported-sucks', 'true');

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'An error occurred.',
                            didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'assertive');
                                notificationRegion.innerText = data.message || 'An error occurred.';
                            }
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'There was an error submitting your report.',
                        didOpen: () => {
                            notificationRegion.setAttribute('aria-live', 'assertive');
                            notificationRegion.innerText = 'There was an error submitting your report.';
                        }
                    });
                });
            }
        });
    }

    function performNAAction() {
        Swal.fire({
            title: 'Confirm Availability',
            text: 'Are you sure this apartment is not available? Your report will be linked to your profile.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, report it',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{% url 'Ranker:ajax_not_available_unit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'unit_id': unitId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Reported',
                            text: 'This apartment has been reported as not available.',
                            didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'polite');
                                notificationRegion.innerText = 'This apartment has been reported as not available.';
                            }
                        });

                        const notAvailBadgeDiv = document.createElement('div');
                        notAvailBadgeDiv.innerHTML = '<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 mb-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300">Reported (Not Avail.)</span>';

                        // Find the <td> with class 'badgeTD'
                        if (badgeTD) {
                            badgeTD.appendChild(notAvailBadgeDiv); // Add the new <div> to the <td>
                        }
                        radioCheckedButton.setAttribute('data-is-reported-na', 'true');

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'An error occurred.',
                            didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'assertive');
                                notificationRegion.innerText = data.message || 'An error occurred.';
                            }
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'There was an error submitting your report.',
                        didOpen: () => {
                                notificationRegion.setAttribute('aria-live', 'assertive');
                                notificationRegion.innerText = 'There was an error submitting your report.';
                            }
                    });
                });
            }
        });
    }

    const editModal = document.getElementById('editModal');
    
    function performEditAction() {
        // {% if request.user.is_staff %}
        const fetchUrl = "{% url 'Ranker:ajax_get_unit_details' unit_id=1 %}".replace('1', unitId);
        // Fetch unit data from the server (for demonstration, assuming data is fetched)
        fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                document.getElementById('unitId').value = data.unitId;
                document.getElementById('category').value = data.category;
                document.getElementById('status').value = data.status;
                document.getElementById('neighborhood').value = data.neighborhood_id;
                document.getElementById('unitType').value = data.unitType_id;
                document.getElementById('listingLink').value = data.listingLink;
                document.getElementById('price').value = data.price;
                document.getElementById('qualityRating').value = data.qualityRating;
                document.getElementById('note').value = data.note;

                editModal.classList.remove('hidden');
            });
        // {% endif %}
    }

    function performDeleteAction() {
        // {% if request.user.is_staff %}
        Swal.fire({
            title: 'Are you sure?',
            text: 'Do you really want to delete this unit? This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`{% url "Ranker:ajax_delete_unit" %}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'unit_id': unitId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'The unit has been deleted.',
                        }).then(() => {
                            location.reload(); // Reload the page to reflect the changes
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.errors || 'An unexpected error occurred.',
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'There was an error processing your request.',
                    });
                });
            }
        });
        // {% endif %}
    }
});
// {% if request.user.is_staff %}
document.addEventListener('DOMContentLoaded', function() {

    const editModal = document.getElementById('editModal');
    const cancelButton = document.getElementById('cancelButton');
    const editForm = document.getElementById('editForm');

    cancelButton.addEventListener('click', function() {
        editModal.classList.add('hidden');
    });

    editForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const unitId = document.getElementById('unitId').value;
        const formData = new FormData(editForm);

        fetch(`{% url "Ranker:ajax_update_unit" %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the table or the UI accordingly
                editModal.classList.add('hidden');
                location.reload(); // Reload the page to see the changes
            } else {
                // Handle errors
                alert('An error occurred while saving the changes.');
            }
        });
    });
});
// {% endif %}
</script>
{% endif %}

{% endblock %}